# Option 1 Spec: Deterministic Upload-to-Sprite Pipeline (No User Prompting)

## Why this option

Given current results with text-driven sprite generation, this roadmap chooses **Option 1**:
- User uploads a character image.
- System converts it into a rigged 2D avatar.
- Animations are generated by deterministic rig playback, not text prompting.

This is optimized for:
- consistent identity retention,
- low per-user cost at scale,
- mobile-ready runtime assets,
- fully automatable QA.

---

## Product constraints (hard requirements)

1. User input is always an uploaded image.
2. Users never need to write prompts.
3. Human + agent co-op model remains intact.
4. Session-token identity remains the only auth model for human flow.
5. Every milestone must be verifiable via Playwright.
6. Output must run on desktop and mobile.

---

## Target output contract (v1)

For each accepted upload, publish an `AvatarPackage`:

- `idle`: 4 directions (`north`, `south`, `east`, `west`), 2 frames each.
- `walk`: 4 directions, 8 frames each.
- Base frame size: `32x48`.
- Delivery scale: `x1` and `x2` (`64x96`) nearest-neighbor.
- Transparent background.
- Sprite atlas PNG + JSON metadata.

`AvatarPackage` must be deterministic:
- Same source bytes + same pipeline version + same template version => identical output hashes.

---

## Architecture (world-class, practical)

### Components

1. **Upload API** (Express)
- Validates file type/size/dimensions.
- Creates `avatar_job` with idempotency key based on file hash.

2. **Pipeline Worker**
- Runs stages: normalize -> segment -> keypoints -> rig fit -> render -> QC.
- Writes stage artifacts and final package.

3. **Asset Store**
- Stage artifacts + sprite atlases on disk/object store.
- Immutable by content hash.

4. **Metadata DB**
- SQLite initially (compatible with existing stack).
- Stores job state, package pointers, hashes, QC scores.

5. **Cache + Queue**
- Redis for job queue, dedupe locks, and hot metadata cache.

6. **Runtime Loader (client)**
- Loads sprite atlas + metadata.
- Uses fixed animation timing and direction states.

---

## Pipeline stages (deterministic)

1. **Normalize**
- Convert to PNG.
- Background separation.
- Crop and center character.
- Scale to canonical working canvas (`128x128`).

2. **Pose + keypoints**
- Detect fixed set of body landmarks.
- Validate full-body completeness.

3. **Rig fitting**
- Fit canonical 2D skeleton to keypoints.
- Use fixed bone lengths and constraints.

4. **Part extraction**
- Segment head/hair/torso/arms/legs/boots/accessories into rig layers.
- Attach each layer to rig anchors.

5. **Render**
- Play fixed animation clips (`idle`, `walk`) over rig.
- Render four directions via deterministic transforms and layer swaps.

6. **Quality gate**
- Reject if silhouette, jitter, or identity score below threshold.
- Return explicit failure reason and remediation hint.

No stage may use user-provided text prompts.

---

## API additions (to be merged into `specs/02_api_contract.md`)

### POST `/api/avatar/upload` (human)

Multipart upload, returns job:
```json
{
  "ok": true,
  "jobId": "avj_...",
  "avatarId": "ava_...",
  "status": "queued"
}
```

### GET `/api/avatar/jobs/:jobId` (human)

```json
{
  "ok": true,
  "job": {
    "jobId": "avj_...",
    "avatarId": "ava_...",
    "status": "queued|running|completed|failed",
    "stage": "normalize|keypoints|rig|render|qc",
    "errorCode": null,
    "createdAt": "ISO8601",
    "updatedAt": "ISO8601"
  }
}
```

### GET `/api/avatar/:avatarId/package` (human)

```json
{
  "ok": true,
  "avatarId": "ava_...",
  "pipelineVersion": "v1.0.0",
  "templateVersion": "t1.0.0",
  "hashes": {
    "atlasPngSha256": "...",
    "metadataJsonSha256": "..."
  },
  "assets": {
    "atlasPng": "/api/avatar/ava_.../atlas.png",
    "metadataJson": "/api/avatar/ava_.../atlas.json"
  }
}
```

### GET `/api/avatar/:avatarId/preview` (human)

Returns a compact preview payload for UI (first frames + status).

---

## Data model (minimum)

`avatars`
- `avatar_id` (pk), `session_id`, `source_sha256`, `pipeline_version`, `template_version`, `status`, timestamps

`avatar_jobs`
- `job_id` (pk), `avatar_id`, `stage`, `status`, `error_code`, `error_detail`, timestamps

`avatar_packages`
- `avatar_id` (pk/fk), `atlas_path`, `metadata_path`, `atlas_sha256`, `metadata_sha256`, `qc_score`, `published_at`

---

## Performance and mobile budgets

1. Sprite package (`x1 + x2 + metadata`) <= 450 KB gzipped.
2. First avatar preview render <= 1.5s on mid-tier mobile over 4G.
3. Runtime animation at 30 FPS minimum on iPhone 12 class device.
4. Job completion p95:
- warm cache <= 8s
- cold <= 20s

---

## TDD milestones (Playwright-first)

Each milestone must land with tests and fixtures before moving on.

## M0: Contracts and fixtures

Deliverables:
- API route stubs with final response shapes.
- Fixed fixture set in `e2e/fixtures/avatar/`.

Playwright:
- `e2e/20_avatar_contract.spec.js`

Pass:
- All new avatar endpoints return schema-correct placeholders.

## M1: Upload + job lifecycle

Deliverables:
- `POST /api/avatar/upload`
- `GET /api/avatar/jobs/:jobId`
- job state machine (`queued -> running -> completed|failed`)

Playwright:
- `e2e/21_avatar_upload_job.spec.js`

Pass:
- Upload starts job.
- Job reaches terminal state.
- Unauthorized session cannot read another sessionâ€™s job.

## M2: Deterministic normalize stage

Deliverables:
- Canonical normalize output (`128x128`, transparent bg).
- Content-hash cache.

Playwright:
- `e2e/22_avatar_normalize_determinism.spec.js`

Pass:
- Two uploads of same bytes produce identical normalized image hash.
- Invalid inputs fail with deterministic error codes.

## M3: Keypoints + rig fit

Deliverables:
- Canonical keypoint set.
- Rig fit with constraints.

Playwright:
- `e2e/23_avatar_rig_fit.spec.js`

Pass:
- Fixture set yields keypoints within tolerance.
- Missing full-body fixtures fail with `FULL_BODY_REQUIRED`.

## M4: Render idle/walk sprite package

Deliverables:
- Atlas renderer for 4-direction idle/walk.
- Metadata JSON schema and frame map.

Playwright:
- `e2e/24_avatar_render_package.spec.js`

Pass:
- Package contains required clips, directions, frame counts.
- Atlas and metadata hashes are stable across repeat runs.

## M5: Quality gates

Deliverables:
- QC scoring: silhouette integrity, temporal jitter, palette drift.
- Failure routing to `failed` with actionable `errorCode`.

Playwright:
- `e2e/25_avatar_quality_gate.spec.js`

Pass:
- Bad fixtures fail QC with expected code.
- Good fixtures pass and publish package.

## M6: Minimal UI integration (desktop + mobile)

Deliverables:
- Upload card on existing flow (minimal UI).
- Preview panel with directional animation loop.

Playwright:
- `e2e/26_avatar_ui_desktop.spec.js`
- `e2e/27_avatar_ui_mobile.spec.js`

Pass:
- Desktop: upload -> processing -> preview.
- Mobile viewport: same flow without layout break or hidden controls.

## M7: Scale, queue, and idempotency

Deliverables:
- Redis queue integration.
- Dedup by source hash + pipeline version.
- Retry policy and dead-letter handling.

Playwright:
- `e2e/28_avatar_queue_idempotency.spec.js`

Pass:
- Burst upload test dedupes identical inputs.
- Retries do not duplicate published packages.

## M8: Runtime integration in world map

Deliverables:
- Avatar package consumed by map renderer.
- Direction + movement state mapped to sprite clips.

Playwright:
- `e2e/29_worldmap_avatar_runtime.spec.js`

Pass:
- Walking left/right/toward/away picks correct clips.
- Mobile map run preserves frame pacing and touch movement.

---

## Definition of done (program-level)

1. All milestone Playwright specs pass in CI.
2. Same input reproduces identical package hashes.
3. No user prompt step exists anywhere in upload flow.
4. API contract updates merged into `specs/02_api_contract.md`.
5. Mobile acceptance tests pass on standard emulated devices.

---

## Execution guidance for AI implementation team

1. Land one milestone per PR.
2. In each PR: tests first, implementation second, fixture updates last.
3. Never relax deterministic checks to make flaky tests pass.
4. Version everything: `pipeline_version`, `template_version`, fixture manifest.
5. If a milestone fails quality goals, do not proceed to next milestone.
